<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Labour Dashboard V2 (Secure)</title>

<style>
  :root{--bg:#0f172a;--panel:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--warn:#ef4444;--brand:#0ea5e9;--line:#1f2937;}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  h1{font-size:1.6rem;margin:0 0 2px}
  .sub{color:var(--muted);font-size:.95rem;margin:0 0 18px}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .authbox{display:flex;gap:8px;align-items:center}
  .avatar{width:28px;height:28px;border-radius:50%;background:#0b1220;border:1px solid var(--line)}
  .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi h3{font-size:.85rem;color:var(--muted);margin:0 0 6px}
  .kpi .v{font-size:1.4rem;font-weight:600}
  .kpi.good .v{color:var(--accent)} .kpi.bad .v{color:var(--warn)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  select,input,button{background:#0b1220;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px;font-size:.95rem}
  input[type="number"]{width:130px}
  button.primary{background:var(--brand);border-color:transparent;color:#001827;font-weight:600}
  .grid{display:grid;gap:12px}
  .section-title{margin:6px 0 6px;font-size:1.05rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:right}
  th:first-child,td:first-child{text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--line);font-size:.8rem;white-space:nowrap}
  .pill.good{border-color:#1d3f2a;color:#8fe2a8}
  .pill.bad{border-color:#4c1f1f;color:#f39a9a}
  .footer{margin-top:24px;color:var(--muted);font-size:.85rem}
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1}
  .small{font-size:.85rem;color:var(--muted)}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){ .two{grid-template-columns:1fr} }
  .denied{border:1px solid #4c1f1f;background:#1b1515}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Labour Dashboard V2</h1>
        <p class="sub">Secure • Sign-in required</p>
      </div>
      <div class="authbox">
        <div id="authStatus" class="muted">Not signed in</div>
        <img class="avatar" id="userAvatar" alt="" hidden />
        <button id="signinBtn" class="primary">Sign in</button>
        <button id="signoutBtn" style="display:none">Sign out</button>
        <button id="settingsBtn" style="display:none">Settings</button>
      </div>
    </div>

    <!-- SETTINGS MODAL (admin only) -->
    <div id="settingsModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; align-items:center; justify-content:center;">
      <div class="card" style="width:560px; max-width:90%; background:var(--panel); border:1px solid var(--line)">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
          <div style="font-weight:600">Location Settings</div>
          <button id="settingsClose">✕</button>
        </div>

        <div class="small" style="margin-bottom:10px">
          These values persist for the selected location until changed by an admin.
          Percentages are decimals (e.g. <code>0.35</code> for 35%).
        </div>

        <div class="row">
          <label>Salaried Mgmt $ (per week)<br>
            <input id="setSalary" type="number" step="0.01" placeholder="0">
          </label>
          <label>Remittance % of Actual Sales<br>
            <input id="setRemitPct" type="number" step="0.0001" placeholder="0.0000">
          </label>
        </div>

        <div class="row">
          <label>Budget % Food<br>
            <input id="setPctFood" type="number" step="0.01" placeholder="0.00">
          </label>
          <label>Budget % Wine<br>
            <input id="setPctWine" type="number" step="0.01" placeholder="0.00">
          </label>
          <label>Budget % Liquor<br>
            <input id="setPctLiquor" type="number" step="0.01" placeholder="0.00">
          </label>
          <label>Budget % Beer<br>
            <input id="setPctBeer" type="number" step="0.01" placeholder="0.00">
          </label>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="settingsSave" class="primary">Save Settings</button>
          <span id="settingsMsg" class="small"></span>
        </div>
      </div>
    </div>

    <!-- AUTH GATE -->
    <div id="authGate" class="card" style="max-width:520px;margin:48px auto 0;">
      <h2>Sign in to view data</h2>
      <div class="small" style="margin-bottom:10px">Use your email and password.</div>
      <div class="row" style="margin-bottom:10px">
        <input id="email" type="email" placeholder="Email" autocomplete="username" />
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <div class="row" style="margin-bottom:10px;align-items:center">
        <button id="doSignin" class="primary">Sign in</button>
        <span id="authMsg" style="color:#fca5a5;display:none"></span>
      </div>
      <div class="small">If you need access, ask an admin to add your account.</div>
    </div>

    <!-- ACCESS DENIED -->
    <div id="denied" class="card denied" style="display:none;max-width:520px;margin:48px auto 0;">
      <h2>Access denied</h2>
      <div class="small">Your account is signed in, but not authorized for this dashboard.</div>
    </div>

    <!-- MAIN APP -->
    <div id="app" hidden>
      <div class="bar">
        <div class="controls card">
          <label class="small">Location</label>
          <select id="locationSel">
            <option value="beacon">Beacon</option>
            <option value="tulia">Tulia</option>
            <option value="cesoir">Ce Soir</option>
            <option value="prohibition">Prohibition</option>
          </select>
        </div>

        <div class="controls card">
          <label class="small">Week of (Monday)</label>
          <input id="weekInput" type="date" />
          <button id="prevBtn">◀</button><button id="nextBtn">▶</button>
        </div>

        <div class="controls card" id="refreshWrap" style="min-width:280px">
          <label style="display:block;font-size:.8rem;color:var(--muted);margin-bottom:6px">Data</label>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
            <button id="refreshBtn" class="primary">Refresh week</button>
            <button id="pdfBtn">Download PDF (all locations)</button>
          </div>
          <div class="small" id="refreshMsg"></div>
          <div class="small" id="syncLine" style="margin-top:4px">Last sync: —</div>
          <div class="small" id="sourceLine">Sales: <span id="salesSource">—</span> • Extras: <span id="extrasSource">—</span></div>
        </div>

        <div class="controls card">
          <label class="small">Target Labour %</label>
          <span id="targetPill" class="pill">—</span>
        </div>
      </div>

      <!-- KPIs -->
      <div class="kpis">
        <div class="card kpi"><h3>Projected Sales</h3><div class="v" id="kpiProjSales">—</div></div>
        <div class="card kpi"><h3>Actual Sales</h3><div class="v" id="kpiActSales">—</div></div>
        <div class="card kpi"><h3>Projected Labour %</h3><div class="v" id="kpiProjPct">—</div></div>
        <div class="card kpi"><h3>Actual Labour %</h3><div class="v" id="kpiActPct">—</div></div>
      </div>

      <!-- DAILY TABLE -->
      <div class="grid" style="margin-top:14px">
        <div class="card">
          <div class="section-title">Daily breakdown (Mon–Sun)</div>
          <table id="dailyTable">
            <thead>
              <tr>
                <th>Date</th><th title="Projected sales">Proj $</th><th title="Actual sales">Act $</th>
                <th title="Projected labour cost">Proj Labour $</th><th title="Actual labour cost">Act Labour $</th>
                <th title="Projected labour minutes">Proj Min</th><th title="Actual labour minutes">Act Min</th>
                <th>Labour %</th><th>Δ vs Target</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th>Total</th>
                <th id="tProjSales">—</th><th id="tActSales">—</th>
                <th id="tProjLabour">—</th><th id="tActLabour">—</th>
                <th id="tProjMin">—</th><th id="tActMin">—</th>
                <th id="tLabourPct">—</th><th id="tDelta">—</th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- MANUAL INPUTS + LAST WEEK / BUDGETS -->
      <div class="two" style="margin-top:12px">
        <div class="card">
          <div class="section-title">Manual inputs (saved per week)</div>

          <div class="row">
            <label>Comps $<br><input id="inComps" type="number" step="0.01" placeholder="0"></label>
            <label>Voids $<br><input id="inVoids" type="number" step="0.01" placeholder="0"></label>
          </div>

          <div class="row">
            <label>Promos/Discounts $<br><input id="inPromos" type="number" step="0.01" placeholder="0"></label>
            <label>Last Week Sales $<br><input id="inLastWeekSales" type="number" step="0.01" placeholder="0"></label>
          </div>

          <div class="row">
            <button id="saveOverrides" class="primary">Save</button>
            <span id="saveMsg" class="small"></span>
          </div>
          <div class="small" style="margin-top:4px">Manual values override auto values if entered.</div>
        </div>

        <div class="card">
          <div class="section-title">Last Week, Auto Feeds & Purchasing Budgets</div>
          <table>
            <tbody>
              <tr><td style="text-align:left">Auto Food Sales (7shifts)</td><td id="vwAutoSales" style="text-align:right">—</td></tr>
              <tr><td style="text-align:left">Promos/Discounts <span id="srcPromos" class="pill" style="margin-left:6px">—</span></td><td id="vwPromos" style="text-align:right">—</td></tr>
              <tr><td style="text-align:left">Voids <span id="srcVoids" class="pill" style="margin-left:6px">—</span></td><td id="vwVoids" style="text-align:right">—</td></tr>
              <tr><td style="text-align:left">Comps <span id="srcComps" class="pill" style="margin-left:6px">—</span></td><td id="vwComps" style="text-align:right">—</td></tr>

              <tr><td colspan="2"><hr style="border:0;border-top:1px solid var(--line)"></td></tr>
              <tr><td style="text-align:left">Last Week Sales (manual)</td><td id="vwLastWeek" style="text-align:right">—</td></tr>
              <tr><td style="text-align:left">Projected Sales (this week)</td><td id="vwProjSales" style="text-align:right">—</td></tr>

              <tr><td colspan="2"><hr style="border:0;border-top:1px solid var(--line)"></td></tr>
              <tr><th style="text-align:left">Category</th><th style="text-align:right">Budget $</th></tr>
              <tr><td style="text-align:left">Food</td><td id="bdgFood" style="text-align:right">—</td></tr>
              <tr><td style="text-align:left">Wine</td><td id="bdgWine" style="text-align:right">—</td></tr>
              <tr><td style="text-align:left">Liquor</td><td id="bdgLiquor" style="text-align:right">—</td></tr>
              <tr><td style="text-align:left">Beer</td><td id="bdgBeer" style="text-align:right">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <p class="footer">Data source: 7shifts Daily Sales & Labor API and Silverware Avrio (via secure Firestore). Overrides are per week; Settings are sticky per location.</p>
    </div>
  </div>

  <!-- Firebase (modular SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDVULptnW9wPbhH6Qn7ys8RGmLqIxUwuCI",
      authDomain: "labour-dashboard.firebaseapp.com",
      projectId: "labour-dashboard",
      storageBucket: "labour-dashboard.appspot.com",
      messagingSenderId: "174483804575",
      appId: "1:174483804575:web:84f6858e812c9705fe6daa"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const functions = getFunctions(app, "us-central1");

    const ALLOWED_UIDS = new Set([
      "e0G8FBe3xlYExc3HvSGtIk5Osgw1",
      "BslFJsAMikSucxwbL8S7qPXcC6r2",
      "9aQ5evQ3nbYt0kjw91ruil5Igq52"
    ]);
    const ADMIN_UIDS = new Set([
      "e0G8FBe3xlYExc3HvSGtIk5Osgw1",
      "BslFJsAMikSucxwbL8S7qPXcC6r2",
      "9aQ5evQ3nbYt0kjw91ruil5Igq52"
    ]);

    // Elements
    const appEl = document.getElementById("app");
    const gateEl = document.getElementById("authGate");
    const deniedEl = document.getElementById("denied");
    const signinBtn = document.getElementById("signinBtn");
    const signoutBtn = document.getElementById("signoutBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const doSignin = document.getElementById("doSignin");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const authMsg = document.getElementById("authMsg");
    const authStatus = document.getElementById("authStatus");
    const userAvatar = document.getElementById("userAvatar");
    const refreshBtn = document.getElementById("refreshBtn");
    const refreshMsg = document.getElementById("refreshMsg");
    const pdfBtn = document.getElementById("pdfBtn");

    const locationSel = document.getElementById("locationSel");
    const weekInput = document.getElementById("weekInput");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    // Integration status
    const syncLine = document.getElementById("syncLine");
    const salesSource = document.getElementById("salesSource");
    const extrasSource = document.getElementById("extrasSource");

    // Settings modal
    const settingsModal = document.getElementById("settingsModal");
    const settingsClose = document.getElementById("settingsClose");
    const settingsSave = document.getElementById("settingsSave");
    const settingsMsg = document.getElementById("settingsMsg");
    const setSalary = document.getElementById("setSalary");
    const setRemitPct = document.getElementById("setRemitPct");
    const setPctFood = document.getElementById("setPctFood");
    const setPctWine = document.getElementById("setPctWine");
    const setPctLiquor = document.getElementById("setPctLiquor");
    const setPctBeer = document.getElementById("setPctBeer");

    // Weekly overrides (editable here)
    const inComps = document.getElementById("inComps");
    const inVoids = document.getElementById("inVoids");
    const inPromos = document.getElementById("inPromos");
    const inLastWeekSales = document.getElementById("inLastWeekSales");
    const saveBtn = document.getElementById("saveOverrides");
    const saveMsg = document.getElementById("saveMsg");

    // Budgets & extras view
    const vwLastWeek = document.getElementById("vwLastWeek");
    const vwProjSales = document.getElementById("vwProjSales");
    const bdgFood = document.getElementById("bdgFood");
    const bdgWine = document.getElementById("bdgWine");
    const bdgLiquor = document.getElementById("bdgLiquor");
    const bdgBeer = document.getElementById("bdgBeer");
    const vwComps = document.getElementById("vwComps");
    const vwVoids = document.getElementById("vwVoids");
    const vwPromos = document.getElementById("vwPromos");
    const vwAutoSales = document.getElementById("vwAutoSales");
    const srcComps = document.getElementById("srcComps");
    const srcVoids = document.getElementById("srcVoids");
    const srcPromos = document.getElementById("srcPromos");

    // KPI refs
    const kpiProjSales = document.getElementById("kpiProjSales");
    const kpiActSales  = document.getElementById("kpiActSales");
    const kpiProjPct   = document.getElementById("kpiProjPct");
    const kpiActPct    = document.getElementById("kpiActPct");

    // Helpers
    const fmtMoney = n => (n==null? "—" : n.toLocaleString(undefined,{style:"currency",currency:"CAD",maximumFractionDigits:0}));
    const fmtInt   = n => (n==null? "—" : Math.round(n).toLocaleString());
    const fmtPct   = n => (n==null? "—" : (n*100).toFixed(1) + "%");
    function getMondayISO(d=new Date()){ const dt=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=dt.getUTCDay()||7; if(day!==1) dt.setUTCDate(dt.getUTCDate()-(day-1)); return dt.toISOString().slice(0,10); }
    function shiftDays(iso,delta){ const d=new Date(iso+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+delta); return d.toISOString().slice(0,10); }
    function num(v){ const n=parseFloat(v); return isNaN(n)?0:n; }
    const isNum = v => typeof v === "number" && isFinite(v);
    const pickVal = (manual, auto) => (isNum(manual) && manual !== 0 ? manual : (isNum(auto) ? auto : 0));
    const pill = (el, txt, good=false, bad=false) => { el.textContent = txt || "—"; el.classList.remove("good","bad"); if (good) el.classList.add("good"); if (bad) el.classList.add("bad"); };

    function getSettingsPath(locKey){ return `companies/aidan/locations/${locKey}/settings/app`; }
    async function loadSettingsFor(locKey){
      const snap = await getDoc(doc(db, getSettingsPath(locKey)));
      return snap.exists() ? snap.data() : {
        salaried_mgmt: 0,
        remit_pct: 0,
        budget_pct_food: 0,
        budget_pct_wine: 0,
        budget_pct_liquor: 0,
        budget_pct_beer: 0
      };
    }
    async function saveSettingsFor(locKey, data){
      await setDoc(doc(db, getSettingsPath(locKey)), data, { merge:true });
    }

    // --- currency scaling (detect cents vs dollars) ---
    function detectCurrencyScale(days = []) {
      for (const d of days) {
        const a = typeof d?.actual_sales === "number" ? d.actual_sales : null;
        const p = typeof d?.projected_sales === "number" ? d.projected_sales : null;
        if ((a != null && a >= 100000) || (p != null && p >= 100000)) return 0.01;
      }
      return 1; // already dollars
    }

    // Defaults
    weekInput.value = getMondayISO(new Date());
    locationSel.value = "beacon";
    prevBtn.onclick = () => { weekInput.value = shiftDays(weekInput.value,-7); load(); };
    nextBtn.onclick = () => { weekInput.value = shiftDays(weekInput.value,+7); load(); };
    locationSel.onchange = load;
    weekInput.onchange = load;

    async function refreshWeek(){
      refreshMsg.textContent = "Dispatching update...";
      try{
        const call = httpsCallable(functions, "dispatchFetchWeek");
        // Backend may ignore or accept extra flags; harmless to include.
        await call({ week_of: weekInput.value, include_sales:true, include_extras:true });
        refreshMsg.textContent = "Update started. Check again shortly.";
      }catch(e){
        refreshMsg.textContent = "Refresh failed: " + (e.message || e);
      }
    }
    refreshBtn.onclick = refreshWeek;

    signinBtn.onclick = () => { gateEl.scrollIntoView({behavior:"smooth",block:"center"}); emailEl.focus(); };
    signoutBtn.onclick = async () => { await signOut(auth); };
    doSignin.onclick = async () => {
      authMsg.style.display="none";
      try { await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value); emailEl.value=""; passEl.value=""; }
      catch(e){ authMsg.textContent = e.message || "Sign-in failed"; authMsg.style.display=""; }
    };

    let IS_ADMIN = false;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authStatus.textContent = "Not signed in";
        userAvatar.hidden = true;
        signoutBtn.style.display = "none";
        signinBtn.style.display = "";
        settingsBtn.style.display = "none";
        appEl.hidden = true;
        deniedEl.style.display = "none";
        if (refreshBtn) refreshBtn.disabled = true;
        if (refreshMsg) refreshMsg.textContent = "";
        if (pdfBtn) { pdfBtn.disabled = true; pdfBtn.onclick = null; }
        syncLine.textContent = "Last sync: —";
        salesSource.textContent = "—";
        extrasSource.textContent = "—";
        return;
      }

      authStatus.textContent = user.email || "Signed in";
      signoutBtn.style.display = "";
      signinBtn.style.display = "none";
      gateEl.style.display = "none";

      userAvatar.hidden = !user.photoURL;
      if (user.photoURL) userAvatar.src = user.photoURL;

      if (!ALLOWED_UIDS.has(user.uid)) {
        appEl.hidden = true;
        deniedEl.style.display = "";
        settingsBtn.style.display = "none";
        if (refreshBtn) refreshBtn.disabled = true;
        if (refreshMsg) refreshMsg.textContent = "Not authorized to refresh.";
        if (pdfBtn) { pdfBtn.disabled = true; pdfBtn.onclick = null; }
        return;
      }

      appEl.hidden = false;
      deniedEl.style.display = "none";

      IS_ADMIN = ADMIN_UIDS.has(user.uid);
      settingsBtn.style.display = IS_ADMIN ? "" : "none";

      if (refreshBtn) { refreshBtn.disabled = false; refreshMsg.textContent = ""; }
      if (pdfBtn) { pdfBtn.disabled = false; pdfBtn.onclick = downloadPdfAll; }

      load();
    });

    // Settings modal
    settingsClose.onclick = () => settingsModal.style.display = "none";
    settingsBtn.onclick = async () => {
      const s = await loadSettingsFor(locationSel.value);
      setSalary.value   = s.salaried_mgmt ?? 0;
      setRemitPct.value = s.remit_pct ?? 0;
      setPctFood.value  = s.budget_pct_food ?? 0;
      setPctWine.value  = s.budget_pct_wine ?? 0;
      setPctLiquor.value= s.budget_pct_liquor ?? 0;
      setPctBeer.value  = s.budget_pct_beer ?? 0;
      settingsMsg.textContent = "";
      settingsModal.style.display = "flex";
    };
    settingsSave.onclick = async () => {
      settingsMsg.textContent = "Saving…";
      try{
        await saveSettingsFor(locationSel.value, {
          salaried_mgmt: num(setSalary.value),
          remit_pct:     num(setRemitPct.value),
          budget_pct_food:   num(setPctFood.value),
          budget_pct_wine:   num(setPctWine.value),
          budget_pct_liquor: num(setPctLiquor.value),
          budget_pct_beer:   num(setPctBeer.value)
        });
        settingsMsg.textContent = "Saved ✓";
        await load();
      }catch(e){
        settingsMsg.textContent = "Save failed: " + (e.message || e);
      }
    };

    // Load + Render
    async function load(){
      saveMsg.textContent = "";
      const weekISO = weekInput.value;
      const locKey = locationSel.value;

      const basePath = `companies/aidan/locations/${locKey}/labour/${weekISO}`;
      const ovrPath  = `companies/aidan/locations/${locKey}/overrides/${weekISO}`;
      const integPath= `companies/aidan/locations/${locKey}/integrations/${weekISO}`;

      const [baseSnap, ovrSnap, settings, integSnap] = await Promise.all([
        getDoc(doc(db, basePath)),
        getDoc(doc(db, ovrPath)),
        loadSettingsFor(locKey),
        getDoc(doc(db, integPath))
      ]);

      const base = baseSnap.exists()? baseSnap.data(): null;
      const ovr  = ovrSnap.exists()? ovrSnap.data(): {};
      const integ= integSnap.exists()? integSnap.data(): null;

      inComps.value         = ovr.comps ?? "";
      inVoids.value         = ovr.voids ?? "";
      inPromos.value        = ovr.promos ?? "";
      inLastWeekSales.value = ovr.last_week_sales ?? "";

      render(base, ovr, settings, integ, weekISO);

      saveBtn.onclick = async () => {
        const newOvr = {
          comps: num(inComps.value),
          voids: num(inVoids.value),
          promos: num(inPromos.value),
          last_week_sales: num(inLastWeekSales.value)
        };
        try{
          await setDoc(doc(db, ovrPath), newOvr, { merge:true });
          saveMsg.textContent = "Saved ✓";
          render(base, newOvr, settings, integ, weekISO);
        }catch(e){
          saveMsg.textContent = "Save failed: " + (e.message || e);
        }
      };
    }

    function render(data, ovr={}, settings={}, integ=null, weekISO){
      const target = data?.target_labour_pct ?? null;
      document.getElementById("targetPill").textContent = target!=null ? fmtPct(target) : "—";

      const days = data?.days ?? [];
      const SCALE = detectCurrencyScale(days);

      const t = { projSales:0, actSales:0, projLab:0, actLab:0, projMin:0, actMin:0 };

      const tbody = document.querySelector("#dailyTable tbody");
      tbody.innerHTML = "";
      for (const d of days){
        t.projSales += (d.projected_sales ?? 0)       * SCALE;
        t.actSales  += (d.actual_sales ?? 0)          * SCALE;
        t.projLab   += (d.projected_labor_cost ?? 0)  * SCALE;
        t.actLab    += (d.actual_labor_cost ?? 0)     * SCALE;
        t.projMin   += d.projected_labor_minutes ?? 0;
        t.actMin    += d.actual_labor_minutes ?? 0;

        const pct = (d.actual_labor_cost && d.actual_sales)
          ? ((d.actual_labor_cost * SCALE) / (d.actual_sales * SCALE))
          : null;
        const delta = (pct!=null && target!=null) ? (pct - target) : null;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.date || "—"}</td>
          <td>${fmtMoney((d.projected_sales ?? 0) * SCALE)}</td>
          <td>${fmtMoney((d.actual_sales ?? 0) * SCALE)}</td>
          <td>${fmtMoney((d.projected_labor_cost ?? 0) * SCALE)}</td>
          <td>${fmtMoney((d.actual_labor_cost ?? 0) * SCALE)}</td>
          <td>${fmtInt(d.projected_labor_minutes)}</td>
          <td>${fmtInt(d.actual_labor_minutes)}</td>
          <td>${fmtPct(pct)}</td>
          <td><span class="pill ${delta!=null?(delta<=0?"good":"bad"):""}">${delta!=null? (delta*100).toFixed(1)+" pp":"—"}</span></td>
        `;
        tbody.appendChild(tr);
      }

      // Salaried & remit adjustments
      const salaried = Number(settings.salaried_mgmt) || 0;
      const remit    = (Number(settings.remit_pct) || 0) * (t.actSales || 0);
      const adjustedActLab = t.actLab + salaried + remit;

      const weekPct   = (adjustedActLab && t.actSales) ? adjustedActLab / t.actSales : null;
      const weekDelta = (weekPct!=null && target!=null) ? (weekPct - target) : null;

      // Totals
      document.getElementById("tProjSales").textContent = fmtMoney(t.projSales);
      document.getElementById("tActSales").textContent  = fmtMoney(t.actSales);
      document.getElementById("tProjLabour").textContent= fmtMoney(t.projLab);
      document.getElementById("tActLabour").textContent = fmtMoney(adjustedActLab);
      document.getElementById("tProjMin").textContent   = fmtInt(t.projMin);
      document.getElementById("tActMin").textContent    = fmtInt(t.actMin);
      document.getElementById("tLabourPct").textContent = fmtPct(weekPct);
      document.getElementById("tDelta").innerHTML = `<span class="pill ${weekDelta!=null?(weekDelta<=0?"good":"bad"):""}">${weekDelta!=null? (weekDelta*100).toFixed(1)+" pp":"—"}</span>`;

      // KPIs
      if (kpiProjSales) kpiProjSales.textContent = fmtMoney(t.projSales);
      if (kpiActSales)  kpiActSales.textContent  = fmtMoney(t.actSales);
      const projPct = (t.projLab && t.projSales) ? (t.projLab / t.projSales) : null;
      if (kpiProjPct)   kpiProjPct.textContent   = fmtPct(projPct);
      if (kpiActPct)    kpiActPct.textContent    = fmtPct(weekPct);

      // Integration status & sources
      const syncAt = integ?.synced_at;
      let syncTxt = "—";
      if (syncAt?.toDate) { // Firestore Timestamp
        syncTxt = integ.synced_at.toDate().toLocaleString();
      } else if (typeof syncAt === "string") {
        const dt = new Date(syncAt);
        syncTxt = isNaN(dt) ? syncAt : dt.toLocaleString();
      }
      syncLine.textContent = "Last sync: " + (syncTxt || "—");

      salesSource.textContent  = integ?.source_sales  ? integ.source_sales  : "—";
      extrasSource.textContent = integ?.source_extras ? integ.source_extras : "—";

      // Last week & budgets widget (budgets from settings)
      vwProjSales.textContent = fmtMoney(t.projSales);
      vwLastWeek.textContent  = fmtMoney(Number(ovr.last_week_sales)||0);

      // Auto feeds surfaced (do not affect labour math unless your backend writes into days)
      const autoSales = isNum(integ?.sales_7shifts_total) ? integ.sales_7shifts_total : (isNum(integ?.food_sales_total) ? integ.food_sales_total : null);
      vwAutoSales.textContent = fmtMoney(autoSales);

      const autoComps  = isNum(integ?.comps_silverware)  ? integ.comps_silverware  : (isNum(integ?.comps)  ? integ.comps  : null);
      const autoVoids  = isNum(integ?.voids_silverware)  ? integ.voids_silverware  : (isNum(integ?.voids)  ? integ.voids  : null);
      const autoPromos = isNum(integ?.promos_silverware) ? integ.promos_silverware : (isNum(integ?.promos) ? integ.promos : null);

      const effComps  = pickVal(Number(ovr.comps),  autoComps);
      const effVoids  = pickVal(Number(ovr.voids),  autoVoids);
      const effPromos = pickVal(Number(ovr.promos), autoPromos);

      vwComps.textContent  = fmtMoney(effComps);
      vwVoids.textContent  = fmtMoney(effVoids);
      vwPromos.textContent = fmtMoney(effPromos);

      pill(srcComps,  (isNum(ovr.comps)  && ovr.comps!==0)  ? "Manual" : (integ?.source_extras ? `Auto: ${integ.source_extras}` : "—"));
      pill(srcVoids,  (isNum(ovr.voids)  && ovr.voids!==0)  ? "Manual" : (integ?.source_extras ? `Auto: ${integ.source_extras}` : "—"));
      pill(srcPromos, (isNum(ovr.promos) && ovr.promos!==0) ? "Manual" : (integ?.source_extras ? `Auto: ${integ.source_extras}` : "—"));

      // Budgets from settings (percentages of projected sales)
      const pFood   = Number(settings.budget_pct_food)||0;
      const pWine   = Number(settings.budget_pct_wine)||0;
      const pLiquor = Number(settings.budget_pct_liquor)||0;
      const pBeer   = Number(settings.budget_pct_beer)||0;

      const bdg = (pct)=> t.projSales * pct;  // already scaled to dollars
      bdgFood.textContent   = fmtMoney(bdg(pFood));
      bdgWine.textContent   = fmtMoney(bdg(pWine));
      bdgLiquor.textContent = fmtMoney(bdg(pLiquor));
      bdgBeer.textContent   = fmtMoney(bdg(pBeer));
    }

    // ---------------------- PDF GENERATOR ----------------------
    const LOC_LABEL = { beacon:"BEACON", tulia:"TULIA", cesoir:"CE SOIR", prohibition:"PROHIBITION" };
    const LOC_ORDER = ["beacon","tulia","cesoir","prohibition"];

    async function readWeekForLocation(locKey, weekISO){
      const basePath = `companies/aidan/locations/${locKey}/labour/${weekISO}`;
      const ovrPath  = `companies/aidan/locations/${locKey}/overrides/${weekISO}`;

      const [baseSnap, ovrSnap, settings] = await Promise.all([
        getDoc(doc(db, basePath)),
        getDoc(doc(db, ovrPath)),
        loadSettingsFor(locKey)
      ]);
      const base = baseSnap.exists()? baseSnap.data(): null;
      const ovr  = ovrSnap.exists()? ovrSnap.data(): {};

      const days = base?.days || [];
      const SCALE = detectCurrencyScale(days);

      let projSales=0, actSales=0, projLab=0, actLab=0, projMin=0, actMin=0;
      for (const d of days){
        projSales += (d.projected_sales ?? 0)       * SCALE;
        actSales  += (d.actual_sales ?? 0)          * SCALE;
        projLab   += (d.projected_labor_cost ?? 0)  * SCALE;
        actLab    += (d.actual_labor_cost ?? 0)     * SCALE;
        projMin   += d.projected_labor_minutes ?? 0;
        actMin    += d.actual_labor_minutes ?? 0;
      }

      const salaried = Number(settings.salaried_mgmt)||0;
      const remit    = (Number(settings.remit_pct)||0) * (actSales || 0);
      const adjActLab = actLab + salaried + remit;

      const target = base?.target_labour_pct ?? null;
      const projPct = (projLab && projSales) ? projLab/projSales : null;
      const actPct  = (adjActLab && actSales) ? adjActLab/actSales : null;
      const delta   = (actPct!=null && target!=null) ? (actPct-target) : null;

      const budgets = {
        food:   projSales * (Number(settings.budget_pct_food)||0),
        wine:   projSales * (Number(settings.budget_pct_wine)||0),
        liquor: projSales * (Number(settings.budget_pct_liquor)||0),
        beer:   projSales * (Number(settings.budget_pct_beer)||0),
      };

      return {
        locKey,
        target,
        projSales, actSales,
        projLab,   actLab: adjActLab,
        projMin,   actMin,
        projPct,   actPct, delta,
        comps: Number(ovr.comps)||0,
        voids: Number(ovr.voids)||0,
        lastWeek: Number(ovr.last_week_sales)||0,
        budgets
      };
    }

    function sectionHtml(s, weekISO){
      const fmtMoneyLocal = (n)=> (n==null? "—" : n.toLocaleString(undefined,{style:"currency",currency:"CAD",maximumFractionDigits:0}));
      const fmtIntLocal   = (n)=> (n==null? "—" : Math.round(n).toLocaleString());
      const fmtPctLocal   = (n)=> (n==null? "—" : (n*100).toFixed(1) + "%");
      return `
        <section class="loc">
          <div class="loc-hdr">
            <div class="loc-name">${(LOC_LABEL[s.locKey] || s.locKey.toUpperCase())}</div>
            <div class="loc-week">Week of ${weekISO}</div>
          </div>

          <div class="kpis">
            <div class="k"><div class="k-h">Projected Sales</div><div class="k-v">${fmtMoneyLocal(s.projSales)}</div></div>
            <div class="k"><div class="k-h">Actual Sales</div><div class="k-v">${fmtPctLocal(s.actPct)!=="—"?fmtMoneyLocal(s.actSales):fmtMoneyLocal(s.actSales)}</div></div>
            <div class="k"><div class="k-h">Projected Labour %</div><div class="k-v">${fmtPctLocal(s.projPct)}</div></div>
            <div class="k ${s.delta!=null && s.delta>0 ? "bad": "good"}"><div class="k-h">Actual Labour %</div><div class="k-v">${fmtPctLocal(s.actPct)}</div></div>
          </div>

          <table class="mini">
            <tbody>
              <tr><th>Total Proj Labour $</th><td>${fmtMoneyLocal(s.projLab)}</td><th>Total Act Labour $</th><td>${fmtMoneyLocal(s.actLab)}</td></tr>
              <tr><th>Target Labour %</th><td>${fmtPctLocal(s.target)}</td><th>Δ vs Target</th><td>${s.delta==null?"—":(s.delta*100).toFixed(1)+" pp"}</td></tr>
              <tr><th>Proj Min</th><td>${fmtIntLocal(s.projMin)}</td><th>Act Min</th><td>${fmtIntLocal(s.actMin)}</td></tr>
            </tbody>
          </table>

          <div class="two-col">
            <table class="mini">
              <thead><tr><th colspan="2">Last Week & Extras</th></tr></thead>
              <tbody>
                <tr><th>Last Week Sales</th><td>${fmtMoneyLocal(s.lastWeek)}</td></tr>
                <tr><th>Comps</th><td>${fmtMoneyLocal(s.comps)}</td></tr>
                <tr><th>Voids</th><td>${fmtMoneyLocal(s.voids)}</td></tr>
              </tbody>
            </table>

            <table class="mini">
              <thead><tr><th colspan="2">Purchasing Budgets</th></tr></thead>
              <tbody>
                <tr><th>Food</th><td>${fmtMoneyLocal(s.budgets.food)}</td></tr>
                <tr><th>Wine</th><td>${fmtMoneyLocal(s.budgets.wine)}</td></tr>
                <tr><th>Liquor</th><td>${fmtMoneyLocal(s.budgets.liquor)}</td></tr>
                <tr><th>Beer</th><td>${fmtMoneyLocal(s.budgets.beer)}</td></tr>
              </tbody>
            </table>
          </div>
        </section>
      `;
    }

    async function downloadPdfAll(){
      const weekISO = weekInput.value;
      const results = await Promise.all(LOC_ORDER.map(loc => readWeekForLocation(loc, weekISO)));
      const sections = results.map(r => sectionHtml(r, weekISO)).join("");

      const w = window.open("", "_blank");
      w.document.write(`<!doctype html><html><head><meta charset="utf-8">
        <title>Labour Dashboard — ${weekISO}</title>
        <style>
          @media print { @page { size: Letter; margin: 14mm; } }
          body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;margin:0;color:#111}
          .wrap{max-width:980px;margin:24px auto;padding:0 16px}
          .title{font-weight:700;font-size:20px;margin:8px 0 16px}
          .loc{page-break-inside:avoid;border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:0 0 16px}
          .loc-hdr{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:6px}
          .loc-name{font-weight:700;font-size:18px}
          .loc-week{color:#6b7280;font-size:12px}
          .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0 6px}
          .k{border:1px solid #e5e7eb;border-radius:10px;padding:10px}
          .k-h{font-size:12px;color:#6b7280;margin-bottom:4px}
          .k-v{font-size:16px;font-weight:600}
          .k.good .k-v{color:#16a34a}
          .k.bad .k-v{color:#dc2626}
          .mini{width:100%;border-collapse:collapse;margin-top:6px}
          .mini th,.mini td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:right}
          .mini th:first-child,.mini td:first-child{text-align:left}
          .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px}
          @media (max-width:800px){ .kpis{grid-template-columns:repeat(2,1fr)} .two-col{grid-template-columns:1fr} }
        </style>
      </head><body><div class="wrap">
        <div class="title">Labour Dashboard — Week of ${weekISO}</div>
        ${sections}
      </div></body></html>`);
      w.document.close();
      w.focus();
      w.print();
    }
    // -------------------- end PDF GENERATOR --------------------
  </script>
</body>
</html>
