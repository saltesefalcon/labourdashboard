<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Labour Dashboard</title>

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af;
    --accent:#22c55e; --warn:#ef4444; --brand:#0ea5e9; --line:#1f2937;
    --gold:#d4af37;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:16px}
  h1{font-size:1.6rem;margin:0 0 2px}
  .sub{color:var(--muted);font-size:.95rem;margin:0 0 18px}
  .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:12px 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi h3{font-size:.85rem;color:var(--muted);margin:0 0 6px}
  .kpi .v{font-size:1.4rem;font-weight:600}
  .kpi.good .v{color:var(--accent)}
  .kpi.bad .v{color:var(--warn)}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  select,input,button{
    background:#0b1220;color:var(--ink);border:1px solid var(--line);
    border-radius:10px;padding:8px 10px;font-size:.95rem
  }
  button.primary{background:var(--brand);border-color:transparent;color:#001827;font-weight:600}
  .grid{display:grid;gap:12px}
  .section-title{margin:6px 0 6px;font-size:1.05rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:right}
  th:first-child,td:first-child{text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--line);font-size:.8rem}
  .pill.good{border-color:#1d3f2a;color:#8fe2a8}
  .pill.bad{border-color:#4c1f1f;color:#f39a9a}
  .footer{margin-top:24px;color:var(--muted);font-size:.85rem}
  @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Labour Dashboard</h1>
    <p class="sub">Weekly labour vs. sales — fed by 7shifts / stored in Firebase</p>

    <div class="bar">
      <div class="controls card">
        <label style="display:block;font-size:.8rem;color:var(--muted);margin-bottom:6px">Location</label>
        <select id="locationSel">
          <!-- Make sure these IDs match your backend writer -->
          <option value="beacon">Beacon</option>
          <option value="tulia">Tulia</option>
          <option value="cesoir">Ce Soir</option>
          <option value="prohibition">Prohibition</option>
        </select>
      </div>

      <div class="controls card">
        <label style="display:block;font-size:.8rem;color:var(--muted);margin-bottom:6px">Week of (Monday)</label>
        <input id="weekInput" type="date" />
        <button id="prevBtn">◀</button>
        <button id="nextBtn">▶</button>
      </div>

      <div class="controls card">
        <label style="display:block;font-size:.8rem;color:var(--muted);margin-bottom:6px">Target Labour %</label>
        <span id="targetPill" class="pill">—</span>
      </div>
    </div>

    <div class="kpis">
      <div class="card kpi"><h3>Projected Sales</h3><div class="v" id="kpiProjSales">—</div></div>
      <div class="card kpi"><h3>Actual Sales</h3><div class="v" id="kpiActSales">—</div></div>
      <div class="card kpi"><h3>Projected Labour %</h3><div class="v" id="kpiProjPct">—</div></div>
      <div class="card kpi"><h3>Actual Labour %</h3><div class="v" id="kpiActPct">—</div></div>
    </div>

    <div class="grid" style="margin-top:14px">
      <div class="card">
        <div class="section-title">Daily breakdown (Mon–Sun)</div>
        <table id="dailyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th title="Projected sales">Proj $</th>
              <th title="Actual sales">Act $</th>
              <th title="Projected labour cost">Proj Labour $</th>
              <th title="Actual labour cost">Act Labour $</th>
              <th title="Projected labour minutes">Proj Min</th>
              <th title="Actual labour minutes">Act Min</th>
              <th>Labour %</th>
              <th>Δ vs Target</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th>Total</th>
              <th id="tProjSales">—</th>
              <th id="tActSales">—</th>
              <th id="tProjLabour">—</th>
              <th id="tActLabour">—</th>
              <th id="tProjMin">—</th>
              <th id="tActMin">—</th>
              <th id="tLabourPct">—</th>
              <th id="tDelta">—</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <p class="footer">Data source: 7shifts Daily Sales & Labor API. Sales and labour values are per day; weekly KPIs are sums/weighted % for the selected Monday–Sunday range.</p>
  </div>

  <!-- Firebase (modular SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // TODO: replace with your Firebase web config
    const firebaseConfig = {
      apiKey: "FIREBASE_API_KEY",
      authDomain: "FIREBASE_AUTH_DOMAIN",
      projectId: "FIREBASE_PROJECT_ID",
      storageBucket: "FIREBASE_STORAGE_BUCKET",
      messagingSenderId: "FIREBASE_SENDER_ID",
      appId: "FIREBASE_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // location -> Firestore doc key your backend writes to
    const LOCATION_KEYS = {
      beacon: "beacon",
      tulia: "tulia",
      cesoir: "cesoir",
      prohibition: "prohibition",
    };

    // Helpers
    const fmtMoney = n => (n==null? "—" : n.toLocaleString(undefined,{style:"currency",currency:"CAD",maximumFractionDigits:0}));
    const fmtInt   = n => (n==null? "—" : Math.round(n).toLocaleString());
    const fmtPct   = n => (n==null? "—" : (n*100).toFixed(1) + "%");

    function getMondayISO(d=new Date()){
      const dt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const day = dt.getUTCDay() || 7; // Sun=0
      if (day !== 1) dt.setUTCDate(dt.getUTCDate() - (day - 1));
      return dt.toISOString().slice(0,10);
    }
    function shiftDays(iso, delta){
      const d = new Date(iso+"T00:00:00Z"); d.setUTCDate(d.getUTCDate()+delta); return d.toISOString().slice(0,10);
    }

    const locationSel = document.getElementById("locationSel");
    const weekInput = document.getElementById("weekInput");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    // set defaults
    weekInput.value = getMondayISO(new Date());
    locationSel.value = "tulia"; // default like your trackers; change if needed

    prevBtn.onclick = () => { weekInput.value = shiftDays(weekInput.value, -7); load(); };
    nextBtn.onclick = () => { weekInput.value = shiftDays(weekInput.value, +7); load(); };
    locationSel.onchange = load;
    weekInput.onchange = load;

    async function load(){
      const locKey = LOCATION_KEYS[locationSel.value];
      const weekISO = weekInput.value;
      const path = `companies/aidan/locations/${locKey}/labour/weeks/${weekISO}`;
      const snap = await getDoc(doc(db, path));
      const data = snap.exists() ? snap.data() : null;
      render(data);
    }

    function render(data){
      const target = data?.target_labour_pct ?? null;
      const targetPill = document.getElementById("targetPill");
      targetPill.textContent = target!=null ? fmtPct(target) : "—";

      const days = data?.days ?? [];
      const t = { projSales:0, actSales:0, projLab:0, actLab:0, projMin:0, actMin:0 };

      const tbody = document.querySelector("#dailyTable tbody");
      tbody.innerHTML = "";
      for (const d of days){
        t.projSales += d.projected_sales ?? 0;
        t.actSales  += d.actual_sales ?? 0;
        t.projLab   += d.projected_labor_cost ?? 0;
        t.actLab    += d.actual_labor_cost ?? 0;
        t.projMin   += d.projected_labor_minutes ?? 0;
        t.actMin    += d.actual_labor_minutes ?? 0;

        const pct = (d.actual_labor_cost && d.actual_sales) ? d.actual_labor_cost / d.actual_sales : null;
        const delta = (pct!=null && target!=null) ? (pct - target) : null;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.date || "—"}</td>
          <td>${fmtMoney(d.projected_sales)}</td>
          <td>${fmtMoney(d.actual_sales)}</td>
          <td>${fmtMoney(d.projected_labor_cost)}</td>
          <td>${fmtMoney(d.actual_labor_cost)}</td>
          <td>${fmtInt(d.projected_labor_minutes)}</td>
          <td>${fmtInt(d.actual_labor_minutes)}</td>
          <td>${fmtPct(pct)}</td>
          <td><span class="pill ${delta!=null?(delta<=0?"good":"bad"):""}">${delta!=null? (delta*100).toFixed(1)+" pp":"—"}</span></td>
        `;
        tbody.appendChild(tr);
      }

      // totals
      const weekPct = (t.actLab && t.actSales) ? t.actLab / t.actSales : null;
      const weekDelta = (weekPct!=null && target!=null) ? (weekPct - target) : null;
      document.getElementById("tProjSales").textContent = fmtMoney(t.projSales);
      document.getElementById("tActSales").textContent = fmtMoney(t.actSales);
      document.getElementById("tProjLabour").textContent = fmtMoney(t.projLab);
      document.getElementById("tActLabour").textContent = fmtMoney(t.actLab);
      document.getElementById("tProjMin").textContent = fmtInt(t.projMin);
      document.getElementById("tActMin").textContent = fmtInt(t.actMin);
      document.getElementById("tLabourPct").textContent = fmtPct(weekPct);
      document.getElementById("tDelta").innerHTML = `<span class="pill ${weekDelta!=null?(weekDelta<=0?"good":"bad"):""}">${weekDelta!=null? (weekDelta*100).toFixed(1)+" pp":"—"}</span>`;

      // headline KPIs (weighted)
      document.getElementById("kpiProjSales").textContent = fmtMoney(t.projSales);
      document.getElementById("kpiActSales").textContent  = fmtMoney(t.actSales);
      document.getElementById("kpiProjPct").textContent   = fmtPct( (t.projLab && t.projSales) ? t.projLab/t.projSales : null );
      document.getElementById("kpiActPct").textContent    = fmtPct( weekPct );
      for (const id of ["kpiProjPct","kpiActPct"]){
        const el = document.getElementById(id).parentElement;
        if (target!=null && weekPct!=null && id==="kpiActPct"){
          el.classList.remove("good","bad");
          el.classList.add(weekDelta<=0?"good":"bad");
        } else {
          el.classList.remove("good","bad");
        }
      }
    }

    load();
  </script>
</body>
</html>
